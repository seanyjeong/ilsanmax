<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ê²°ì œ ìš”ì•½ ëŒ€ì‹œë³´ë“œ</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/water.css@2/out/light.css" />
  <style>
    .summary-box {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 1rem;
      margin-top: 1rem;
    }
    .card {
      border: 1px solid #ccc;
      border-radius: 10px;
      padding: 1rem;
      background: #fefefe;
      box-shadow: 1px 1px 4px rgba(0,0,0,0.1);
    }
    h1 { margin-top: 1rem; }
    table {
      width: 100%;
      font-size: 0.9rem;
      margin-top: 2rem;
    }
    th, td {
      text-align: center;
      padding: 6px;
      vertical-align: middle;
    }
  </style>
</head>
<body>
  <h1>ğŸ“Š ê²°ì œ ìš”ì•½ ëŒ€ì‹œë³´ë“œ</h1>

  <label>ğŸ“… ì›” ì„ íƒ:
    <input type="month" id="month" value="2025-05">
  </label>
  <button onclick="loadSummary()">ì¡°íšŒ</button>

  <div class="summary-box">
    <div class="card"><h3>ì´ ì¸ì›</h3><p id="total-count">-</p></div>
    <div class="card"><h3>íœ´ì‹ ì¸ì›</h3><p id="rest-count">-</p></div>
    <div class="card"><h3>ë‚©ë¶€ ì™„ë£Œ</h3><p id="paid-count">-</p></div>
    <div class="card"><h3>ë¯¸ë‚©</h3><p id="unpaid-count">-</p></div>
    <div class="card"><h3>ë‚©ë¶€ìœ¨</h3><p id="paid-rate">-</p></div>
    <div class="card"><h3>ì¹´ë“œ ë‚©ë¶€ì•¡</h3><p id="card-sum">-</p></div>
    <div class="card"><h3>ê³„ì¢Œ ë‚©ë¶€ì•¡</h3><p id="account-sum">-</p></div>
    <div class="card"><h3>ì´ ë‚©ë¶€ì•¡</h3><p id="total-paid-sum">-</p></div>
    <div class="card"><h3>ì˜ˆìƒ ë‚©ë¶€ ì´ì•¡</h3><p id="expected-sum">-</p></div>
  </div>

  <h3>â— ë¯¸ë‚©ì ë¦¬ìŠ¤íŠ¸</h3>
  <table>
    <thead>
      <tr>
        <th>ì´ë¦„</th><th>í•™êµ</th><th>í•™ë…„</th><th>ì „í™”ë²ˆí˜¸</th><th>ì˜ˆì •ê¸ˆì•¡</th>
      </tr>
    </thead>
    <tbody id="unpaid-list"></tbody>
  </table>

  <script>
    const API = 'https://supermax.kr/college';

    async function loadSummary() {
  const month = document.getElementById('month').value;
  const today = new Date();
  const targetDate = new Date(month + '-01');
  const isFuture = targetDate > today;

  let statusData = [], methodData = {};
  try {
    const [statusRes, methodRes] = await Promise.all([
      fetch(`${API}/payment-status-summary?month=${month}`),
      fetch(`${API}/payment-summary-by-method?month=${month}`)
    ]);
    statusData = await statusRes.json();
    methodData = await methodRes.json();
  } catch (e) {
    alert('âŒ ì„œë²„ ì˜¤ë¥˜: ' + (e.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
    return;
  }

  // â— 'í‡´ì›' ì œì™¸
  const filtered = statusData.filter(row => row.status !== 'í‡´ì›');
  const rest = filtered.filter(row => row.status === 'íœ´ì‹');
  const active = filtered.filter(row => row.status === 'ì¬ì›' || row.status === 'ë¯¸ë‚©' || row.status === 'ë‚©ë¶€ì™„ë£Œ');

  const total = filtered.length;
  const restCount = rest.length;

  const paidList = active.filter(s => s.status === 'ë‚©ë¶€ì™„ë£Œ');
  const unpaidList = isFuture ? [] : active.filter(s => s.status === 'ë¯¸ë‚©');

  const paid = paidList.length;
  const unpaid = unpaidList.length;
  const rate = active.length ? ((paid / active.length) * 100).toFixed(1) + '%' : '-';

  const expectedSum = active.reduce((sum, s) => sum + (s.expected_amount || 0), 0);

  const card = methodData?.['ì¹´ë“œ'] || 0;
  const account = methodData?.['ê³„ì¢Œ'] || 0;

  // âœ… ìš”ì•½ í…ìŠ¤íŠ¸ ë Œë”ë§
  document.getElementById('total-count').innerText = total;
  document.getElementById('rest-count').innerText = restCount;
  document.getElementById('paid-count').innerText = paid;
  document.getElementById('unpaid-count').innerText = unpaid;
  document.getElementById('paid-rate').innerText = rate;
  document.getElementById('card-sum').innerText = card.toLocaleString() + 'ì›';
  document.getElementById('account-sum').innerText = account.toLocaleString() + 'ì›';
  document.getElementById('total-paid-sum').innerText = (card + account).toLocaleString() + 'ì›';
  document.getElementById('expected-sum').innerText = expectedSum.toLocaleString() + 'ì›';

  // âœ… ë¯¸ë‚©ì ë¦¬ìŠ¤íŠ¸ ë Œë”ë§
  const tbody = document.getElementById('unpaid-list');
  tbody.innerHTML = '';
  unpaidList.forEach(row => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${row.name}</td>
      <td>${row.school || '-'}</td>
      <td>${row.grade}</td>
      <td>${row.phone || '-'}</td>
      <td>${(row.expected_amount || 0).toLocaleString()}ì›</td>
    `;
    tbody.appendChild(tr);
  });
}




    loadSummary();
  </script>
</body>
</html>
