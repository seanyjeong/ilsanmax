<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>맥스체대입시 실기 테스트 종합 순위</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    :root {
      --primary: #2c3e50;
      --secondary: #3498db;
      --accent: #e74c3c;
      --light: #ecf0f1;
      --dark: #2c3e50;
      --text: #333;
      --border-radius: 8px;
      --box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
      --transition: all 0.3s ease;
      --male-bg: #e6f2ff;
      --female-bg: #ffebee;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Noto Sans KR', sans-serif;
      background-color: #f5f7fa;
      color: var(--text);
      line-height: 1.6;
    }

    .container {
      width: 100%;
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }

    .header {
      text-align: center;
      margin-bottom: 20px;
      padding: 15px;
      background-color: white;
      border-radius: var(--border-radius);
      box-shadow: var(--box-shadow);
    }

    .header h1 {
      color: var(--primary);
      font-size: 2rem;
      margin-bottom: 10px;
    }

    .tagline {
      font-size: 1.1rem;
      color: #666;
      margin-bottom: 15px;
      text-align: center;
      font-weight: 500;
    }

    .controls {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      flex-wrap: wrap;
      gap: 10px;
    }

    .month-select-wrapper {
      background: white;
      border: 1px solid #ddd;
      border-radius: var(--border-radius);
      padding: 8px 15px;
      box-shadow: var(--box-shadow);
      font-size: 0.95rem;
    }

    .month-select-wrapper select {
      border: none;
      font-size: 1rem;
      background: transparent;
      outline: none;
      cursor: pointer;
      font-weight: 500;
    }

    .event-filters {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      justify-content: center;
    }

    .event-filter {
      padding: 8px 15px;
      background-color: var(--light);
      border-radius: var(--border-radius);
      cursor: pointer;
      font-weight: 500;
      transition: var(--transition);
      border: 1px solid #ddd;
    }

    .event-filter:hover {
      background-color: var(--secondary);
      color: white;
    }

    .event-filter.active {
      background-color: var(--secondary);
      color: white;
      font-weight: 600;
    }

    .gender-section {
      margin-bottom: 30px;
    }

    .gender-title {
      font-size: 1.3rem;
      font-weight: 700;
      padding: 10px 15px;
      border-radius: var(--border-radius) var(--border-radius) 0 0;
      margin-bottom: 0;
    }

    .male-title {
      background-color: var(--secondary);
      color: white;
    }

    .female-title {
      background-color: var(--accent);
      color: white;
    }

    .ranking-container {
      background-color: white;
      border-radius: 0 0 var(--border-radius) var(--border-radius);
      box-shadow: var(--box-shadow);
      overflow: hidden;
    }

    .male-ranking {
      background-color: var(--male-bg);
    }

    .female-ranking {
      background-color: var(--female-bg);
    }

    .ranking-header {
      display: grid;
      grid-template-columns: 60px 1fr 100px 120px 100px;
      background-color: var(--primary);
      color: white;
      padding: 12px 15px;
      font-weight: 600;
    }

    .ranking-row {
      display: grid;
      grid-template-columns: 60px 1fr 100px 120px 100px;
      padding: 12px 15px;
      border-bottom: 1px solid #eee;
      align-items: center;
    }

    .ranking-row:nth-child(even) {
      opacity: 0.95;
    }

    .rank {
      font-weight: 700;
      color: var(--primary);
    }

    .student-name {
      font-weight: 600;
    }

    .student-info {
      font-size: 0.85rem;
      color: #666;
      margin-top: 3px;
    }

    .score {
      font-weight: 700;
      text-align: right;
    }

    .total-score {
      color: var(--accent);
    }

    .loading {
      text-align: center;
      padding: 40px;
      font-size: 1.1rem;
      color: var(--secondary);
    }

    .no-data {
      text-align: center;
      padding: 40px;
      font-size: 1.1rem;
      color: #666;
    }

    .footer {
      text-align: center;
      padding: 30px 0;
      margin-top: 30px;
    }

    .footer img {
      max-height: 120px;
    }

    @media (max-width: 768px) {
      .ranking-header, .ranking-row {
        grid-template-columns: 50px 1fr 80px;
      }

      .mobile-hide {
        display: none;
      }

      .header h1 {
        font-size: 1.6rem;
      }

      .controls {
        flex-direction: column;
      }

      .event-filters {
        width: 100%;
        overflow-x: auto;
        justify-content: flex-start;
        padding-bottom: 10px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1 id="mainTitle">맥스체대입시 실기 테스트 종합 순위</h1>
      <p class="tagline">전국 체대입시 1위 맥스와 함께하면, 당신의 기록이 달라집니다.</p>
    </div>

    <div class="controls">
      <div class="month-select-wrapper">
        <select id="monthSelect" onchange="fetchData()"></select>
      </div>
      <div class="event-filters" id="eventFilters"></div>
    </div>

    <div id="rankingContainer">
      <div class="loading">데이터를 불러오는 중입니다...</div>
    </div>

    <div class="footer">
      <img src="https://github.com/seanyjeong/supermax/blob/main/maxlogo.png?raw=true" alt="맥스체대입시 로고">
    </div>
  </div>

  <script>
    const events = [
      { id: 'total', name: '종합 순위', valueCol: 'total_score', scoreCol: 'total_score', unit: '점', reverse: false },
      { id: 'jump', name: '제자리멀리뛰기', valueCol: 'jump_cm', scoreCol: 'jump_score', unit: 'cm', reverse: false },
      { id: 'run20m', name: '20m왕복달리기', valueCol: 'run20m_sec', scoreCol: 'run20m_score', unit: '초', reverse: true },
      { id: 'sit_reach', name: '좌전굴', valueCol: 'sit_reach_cm', scoreCol: 'sit_score', unit: 'cm', reverse: false },
      { id: 'situp', name: '윗몸일으키기', valueCol: 'situp_count', scoreCol: 'situp_score', unit: '회', reverse: false },
      { id: 'back', name: '배근력', valueCol: 'back_strength', scoreCol: 'back_score', unit: 'kg', reverse: false },
      { id: 'medball', name: '메디신볼던지기', valueCol: 'medball_m', scoreCol: 'medball_score', unit: 'm', reverse: false },
      { id: 'run10m', name: '10m왕복달리기', valueCol: 'run10m_sec', scoreCol: 'run10m_score', unit: '초', reverse: true }
    ];

    let allRecords = [];
    let currentEvent = events[0];

    async function populateMonthSelect() {
      const select = document.getElementById('monthSelect');
      select.innerHTML = '';
      try {
        const res = await fetch('https://supermax.kr/college/test-months');
        const data = await res.json();

        if (!data.success || !data.months || data.months.length === 0) {
          const opt = document.createElement('option');
          opt.value = '';
          opt.textContent = '데이터 없음';
          select.appendChild(opt);
          return;
        }

        const allOption = document.createElement('option');
        allOption.value = 'all';
        allOption.textContent = '전체 누적 보기';
        select.appendChild(allOption);

        data.months.forEach(month => {
          const option = document.createElement('option');
          option.value = month;
          option.textContent = month;
          select.appendChild(option);
        });

        if (data.months.length > 0) {
          select.value = data.months[0];
        } else {
          select.value = 'all';
        }
      } catch (err) {
        console.error('월 목록 로딩 실패:', err);
        const opt = document.createElement('option');
        opt.value = '';
        opt.textContent = '로딩 실패';
        select.appendChild(opt);
      }
    }

    function populateEventFilters() {
      const container = document.getElementById('eventFilters');
      container.innerHTML = '';
      events.forEach(event => {
        const button = document.createElement('div');
        button.className = `event-filter ${event.id === currentEvent.id ? 'active' : ''}`;
        button.textContent = event.name;
        button.onclick = () => {
          currentEvent = event;
          updateRanking();
          document.querySelectorAll('.event-filter').forEach(btn => {
            btn.classList.remove('active');
          });
          button.classList.add('active');
        };
        container.appendChild(button);
      });
    }

    function getSelectedTestMonth() {
      const select = document.getElementById('monthSelect');
      return select ? select.value : '';
    }

    async function fetchData() {
      try {
        const rankingContainer = document.getElementById('rankingContainer');
        rankingContainer.innerHTML = '<div class="loading">데이터를 불러오는 중입니다...</div>';

        const selectedMonth = getSelectedTestMonth();
        if (!selectedMonth) {
          rankingContainer.innerHTML = '<div class="no-data">조회할 월을 선택하세요.</div>';
          return;
        }

        let apiUrl;
        if (selectedMonth === 'all') {
          apiUrl = 'https://supermax.kr/college/test-records';
        } else {
          apiUrl = `https://supermax.kr/college/test-records?test_month=${selectedMonth}`;
        }

        const res = await fetch(apiUrl);
        const data = await res.json();

        if (data.success && data.records.length > 0) {
          allRecords = data.records;
          const titleEl = document.getElementById('mainTitle');

          if (selectedMonth === 'all') {
            titleEl.textContent = '맥스체대입시 전체 누적 테스트 순위';
          } else {
            const parts = selectedMonth.split('-');
            if (parts.length === 2 && !isNaN(parts[0]) && !isNaN(parts[1])) {
              titleEl.textContent = `맥스체대입시 ${parts[0]}년 ${parseInt(parts[1])}월 종합 테스트 순위`;
            } else {
              titleEl.textContent = `맥스체대입시 ${selectedMonth} 테스트 순위`;
            }
          }

          updateRanking();
        } else {
          allRecords = [];
          updateRanking();
        }
      } catch (error) {
        console.error('데이터 불러오기 오류:', error);
        document.getElementById('rankingContainer').innerHTML =
          '<div class="no-data">데이터를 불러오는 중 오류가 발생했습니다.</div>';
      }
    }

    function createRankingTable(gender) {
      const genderRecords = allRecords.filter(record => {
        const recordGender = record.gender;
        if (gender === 'male') {
          return recordGender === '남' || recordGender === '남자';
        } else {
          return recordGender === '여' || recordGender === '여자';
        }
      });

      const sortedRecords = [...genderRecords]
        .filter(record => record[currentEvent.valueCol] != null && record[currentEvent.valueCol] !== '')
        .sort((a, b) => {
          const valA = (a[currentEvent.valueCol] === 'F') ? (currentEvent.reverse ? Infinity : -Infinity) : parseFloat(a[currentEvent.valueCol]);
          const valB = (b[currentEvent.valueCol] === 'F') ? (currentEvent.reverse ? Infinity : -Infinity) : parseFloat(b[currentEvent.valueCol]);

          if (isNaN(valA)) return 1;
          if (isNaN(valB)) return -1;

          return currentEvent.reverse ? valA - valB : valB - valA;
        });

      let ranking = [];
      let currentRank = 1;

      for (let i = 0; i < sortedRecords.length; i++) {
        const currentVal = sortedRecords[i][currentEvent.valueCol];
        const prevVal = (i > 0) ? sortedRecords[i - 1][currentEvent.valueCol] : null;

        if (i > 0 && currentVal !== prevVal) {
          currentRank = i + 1;
        }

        ranking.push({
          ...sortedRecords[i],
          rank: currentRank
        });
      }

      let html = `
        <div class="gender-section">
          <h3 class="gender-title ${gender === 'male' ? 'male-title' : 'female-title'}">
            ${gender === 'male' ? '남학생 순위' : '여학생 순위'} (${ranking.length}명)
          </h3>
          <div class="ranking-container ${gender === 'male' ? 'male-ranking' : 'female-ranking'}">
            <div class="ranking-header">
              <div>순위</div>
              <div>이름</div>
              <div class="mobile-hide">학교/학년</div>
              <div class="mobile-hide">회차</div>
              <div style="text-align:right;">${currentEvent.name} (${currentEvent.unit})</div>
            </div>
      `;

      if (ranking.length === 0) {
        html += '<div class="no-data">표시할 데이터가 없습니다.</div>';
      } else {
        const showMonth = getSelectedTestMonth() === 'all';

        ranking.forEach(student => {
          const genderText = gender === 'male' ? '남' : '여';
          let displayValue = student[currentEvent.valueCol];

          if (displayValue === 'F') {
            displayValue = 'F';
          } else if (currentEvent.unit === '초' && !isNaN(parseFloat(displayValue))) {
            displayValue = parseFloat(displayValue).toFixed(2);
          } else if (displayValue === null || displayValue === undefined || displayValue === '') {
            displayValue = '-';
          }

          html += `
            <div class="ranking-row">
              <div class="rank">${student.rank}</div>
              <div>
                <div class="student-name">${student.name}</div>
                <div class="student-info mobile-hide">${student.school || ''} ${student.grade || ''}</div>
              </div>
              <div class="mobile-hide">${student.school || '-'} ${student.grade || '-'}</div>
              <div class="mobile-hide">${showMonth ? (student.test_month || '-') : genderText}</div>
              <div class="score ${currentEvent.id === 'total' ? 'total-score' : ''}">
                ${displayValue}${currentEvent.unit}
              </div>
            </div>
          `;
        });
      }

      html += `
          </div>
        </div>
      `;

      return html;
    }

    function updateRanking() {
      const rankingContainer = document.getElementById('rankingContainer');
      const showMonth = getSelectedTestMonth() === 'all';
      document.documentElement.style.setProperty('--ranking-grid-columns', '60px 1fr 100px 120px 100px');
      document.documentElement.style.setProperty('--ranking-grid-columns-mobile', '50px 1fr 80px');

      rankingContainer.innerHTML = `
        ${createRankingTable('male')}
        ${createRankingTable('female')}
      `;

      const headers = document.querySelectorAll('.ranking-header');
      headers.forEach(header => {
        const cols = header.children;
        if (cols.length > 3) {
          if (showMonth) {
            cols[3].textContent = '회차';
          } else {
            cols[3].textContent = '성별';
          }
        }
      });
    }

    document.addEventListener('DOMContentLoaded', async () => {
      await populateMonthSelect();
      populateEventFilters();
      fetchData();
    });
  </script>
</body>
</html>
