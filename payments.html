<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ê²°ì œ ê´€ë¦¬</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/water.css@2/out/light.css" />
  <style>
    h1 { margin: 20px 0; }
    table { width: 100%; font-size: 0.9rem; }
    th, td { text-align: center; vertical-align: middle; }
    select, input[type="number"], input[type="date"] {
      width: 100%;
      box-sizing: border-box;
    }
    .paid { background: #e3ffe3; }
  </style>
</head>
<body>
  <h1>ğŸ’° ê²°ì œ ê´€ë¦¬</h1>
  <label>ğŸ“… ì¡°íšŒí•  ì›”:
    <input type="month" id="month-input" value="2025-05">
  </label>
  <button onclick="loadPayments()">ì¡°íšŒ</button>

  <table>
    <thead>
      <tr>
        <th>ì´ë¦„</th><th>í•™ë…„</th><th>ì˜ˆì •ê¸ˆì•¡</th><th>ë‚©ë¶€ì¼</th><th>ê²°ì œìˆ˜ë‹¨</th><th>ì‹¤ë‚©ë¶€ê¸ˆì•¡</th><th>ìƒíƒœ</th><th>ì €ì¥</th>
      </tr>
    </thead>
    <tbody id="payment-list"></tbody>
  </table>

  <script>
    const API = 'https://supermax.kr/college';

    function countSessionsInMonth(monthStr, weekdaysStr) {
      if (!monthStr || !weekdaysStr) return 0;
      const daysInMonth = new Date(monthStr.split('-')[0], monthStr.split('-')[1], 0).getDate();
      const weekdayMap = { 'ì¼': 0, 'ì›”': 1, 'í™”': 2, 'ìˆ˜': 3, 'ëª©': 4, 'ê¸ˆ': 5, 'í† ': 6 };
      const targetDays = [...weekdaysStr].map(d => weekdayMap[d]);

      let count = 0;
      for (let i = 1; i <= daysInMonth; i++) {
        const date = new Date(`${monthStr}-${String(i).padStart(2, '0')}`);
        if (targetDays.includes(date.getDay())) count++;
      }
      return count;
    }

    async function loadPayments() {
      const month = document.getElementById('month-input').value;
      const res = await fetch(`${API}/payment-list?month=${month}`);
      const data = await res.json();
      const tbody = document.getElementById('payment-list');
      tbody.innerHTML = '';

      const monthDate = new Date(month + '-01');
      const lastDayOfMonth = new Date(monthDate.getFullYear(), monthDate.getMonth() + 1, 0);

      if (!Array.isArray(data)) {
        alert('âŒ ì„œë²„ ì‘ë‹µ ì˜¤ë¥˜');
        return;
      }

      data.forEach(row => {
        const registered = new Date(row.first_registered_at);
        if (registered > lastDayOfMonth) return;
        if (row.status === 'íœ´ì‹' || row.status === 'í‡´ì›') return;

        const weekdays = row.weekdays || '';
        const weeklyCount = [...weekdays].length;
        const sessionCount = countSessionsInMonth(month, weekdays);

        const expectedAmount = weeklyCount >= 5 ? 550000
                              : weeklyCount === 4 ? 500000
                              : weeklyCount === 3 ? 400000
                              : weeklyCount === 2 ? 300000
                              : weeklyCount === 1 ? 150000 : 0;

        const tr = document.createElement('tr');
        tr.className = row.paid_at ? 'paid' : '';
        tr.innerHTML = `
          <td>${row.name}</td>
          <td>${row.grade}</td>
          <td><input type="number" class="expected" value="${expectedAmount}" min="0"></td>
          <td><input type="date" value="${row.paid_at ? row.paid_at.substring(0,10) : ''}" class="paid-at"></td>
          <td>
            <select class="method">
              <option value="">ì„ íƒ</option>
              <option value="ì¹´ë“œ">ì¹´ë“œ</option>
              <option value="ê³„ì¢Œ">ê³„ì¢Œ</option>
            </select>
          </td>
          <td><input type="number" class="amount" value="${row.amount || expectedAmount}"></td>
          <td>${row.paid_at ? 'ë‚©ë¶€ì™„ë£Œ' : 'ë¯¸ë‚©'}</td>
          <td><button onclick="savePayment(${row.student_id}, '${month}', ${sessionCount}, this)">ì €ì¥</button></td>
        `;
        tbody.appendChild(tr);
      });
    }

    async function savePayment(student_id, month, session_count, btn) {
      const tr = btn.closest('tr');
      const amount = tr.querySelector('.amount').value;
      const paid_at = tr.querySelector('.paid-at').value;
      const method = tr.querySelector('.method').value;

      if (!paid_at) return alert('â— ë‚©ë¶€ì¼ìë¥¼ ì…ë ¥í•˜ì„¸ìš”');
      if (!method) return alert('â— ê²°ì œìˆ˜ë‹¨ì„ ì„ íƒí•˜ì„¸ìš”');
      if (!amount) return alert('â— ê¸ˆì•¡ì„ ì…ë ¥í•˜ì„¸ìš”');

      const res = await fetch(`${API}/save-payment`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          student_id,
          month,
          session_count,
          amount: Number(amount),
          is_manual: 1,
          paid_at,
          payment_method: method
        })
      });

      const resultText = await res.text();
      try {
        const result = JSON.parse(resultText);
        alert(result.message);
      } catch {
        alert('ì„œë²„ ì‘ë‹µ ì˜¤ë¥˜: ' + resultText);
      }

      loadPayments();
    }

    loadPayments();
  </script>
</body>
</html>
