<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>ë©˜íƒˆ ìê°€ ì²´í¬</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <style>
    :root {
      --primary-color: #4361ee;
      --secondary-color: #3f37c9;
      --accent-color: #4895ef;
      --success-color: #00c853;
      --light-color: #f8f9fa;
      --dark-color: #212529;
      --border-radius: 12px;
      --box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    * {
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      line-height: 1.6;
      color: var(--dark-color);
      background-color: #f5f7fa;
      margin: 0;
      padding: 0;
      max-width: 100%;
      min-height: 100vh;
    }

    .container {
      max-width: 480px;
      margin: 0 auto;
      padding: 20px;
    }

    header {
      text-align: center;
      margin-bottom: 25px;
    }

    h1 {
      color: var(--primary-color);
      font-size: 1.5rem;
      margin-bottom: 5px;
    }

    .subtitle {
      color: #666;
      font-size: 0.9rem;
      margin-bottom: 20px;
    }

    .form-card {
      background-color: white;
      border-radius: var(--border-radius);
      box-shadow: var(--box-shadow);
      padding: 25px;
      margin-bottom: 20px;
      transition: all 0.3s ease;
    }

    /* ì œì¶œ ì™„ë£Œ í™”ë©´ ìŠ¤íƒ€ì¼ */
    .success-card {
      display: none;
      text-align: center;
      padding: 30px;
    }

    .success-icon {
      font-size: 60px;
      color: var(--success-color);
      margin-bottom: 20px;
      animation: bounce 0.8s;
    }

    @keyframes bounce {
      0%, 20%, 50%, 80%, 100% {transform: translateY(0);}
      40% {transform: translateY(-20px);}
      60% {transform: translateY(-10px);}
    }

    .success-title {
      font-size: 1.4rem;
      font-weight: 600;
      color: var(--dark-color);
      margin-bottom: 10px;
    }

    .success-message {
      color: #666;
      margin-bottom: 25px;
      line-height: 1.5;
    }

    .success-details {
      background-color: #f8f9fa;
      border-radius: var(--border-radius);
      padding: 15px;
      margin: 20px 0;
      text-align: left;
    }

    .detail-item {
      display: flex;
      justify-content: space-between;
      margin-bottom: 8px;
    }

    .detail-label {
      color: #666;
    }

    /* í¼ ìŠ¤íƒ€ì¼ */
    .form-group {
      margin-bottom: 20px;
    }

    label {
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
      color: #444;
    }

    input, select, textarea {
      width: 100%;
      padding: 12px 15px;
      border: 1px solid #ddd;
      border-radius: var(--border-radius);
      font-size: 1rem;
      transition: border-color 0.3s;
    }

    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: var(--accent-color);
    }

    textarea {
      resize: vertical;
      min-height: 100px;
    }

    button {
      background-color: var(--primary-color);
      color: white;
      border: none;
      border-radius: var(--border-radius);
      padding: 14px;
      font-size: 1.1rem;
      font-weight: 500;
      width: 100%;
      cursor: pointer;
      transition: background-color 0.3s;
    }

    button:hover {
      background-color: var(--secondary-color);
    }

    .help-text {
      font-size: 0.85rem;
      color: #666;
      margin-top: 5px;
    }

    .alert {
      padding: 12px 15px;
      border-radius: var(--border-radius);
      margin-bottom: 20px;
      font-size: 0.9rem;
      display: none;
    }

    .alert-warning {
      background-color: #fff3cd;
      color: #856404;
      border-left: 4px solid #ffeeba;
    }

    .alert-success {
      background-color: #d4edda;
      color: #155724;
      border-left: 4px solid #c3e6cb;
    }

    .student-name-input {
      display: flex;
      gap: 10px;
    }

    .student-name-input input {
      flex: 1;
    }

    .student-name-input button {
      width: auto;
      padding: 0 15px;
      background-color: #6c757d;
    }

    @media (max-width: 480px) {
      .container {
        padding: 15px;
      }
      
      .form-card {
        padding: 20px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div id="alertBox" class="alert"></div>

    <header>
      <h1><i class="fas fa-brain"></i> ì¼ì‚°ë§¥ìŠ¤ ë©˜íƒˆ ìê°€ ì²´í¬</h1>
      <div class="subtitle">ë³¸ì¸ì˜ ì •í™•í•œìƒíƒœë¥¼ ì²´í¬í•´ì£¼ì„¸ìš”</div>
    </header>

    <div class="form-card" id="formContainer">
      <form id="mentalForm">
        <div class="form-group">
          <label for="studentName">í•™ìƒ ì´ë¦„</label>
          <div class="student-name-input">
            <input type="text" id="studentName" name="student_name" placeholder="ë³¸ì¸ì˜ ì´ë¦„ì„ ì •í™•íˆ ì…ë ¥" required>
            <button type="button" id="checkNameBtn"><i class="fas fa-search"></i></button>
          </div>
          <div class="help-text">ë“±ë¡ëœ ì´ë¦„ê³¼ ì •í™•íˆ ì¼ì¹˜í•´ì•¼ í•©ë‹ˆë‹¤</div>
          <input type="hidden" id="studentId" name="student_id">
        </div>

        <div class="form-group">
          <label for="sleepHours">ìˆ˜ë©´ ì‹œê°„ (ì‹œê°„)</label>
          <input type="number" id="sleepHours" name="sleep_hours" step="0.5" min="0" max="24" placeholder="ì˜ˆ: 6.5">
        </div>

        <div class="form-group">
          <label for="stressLevel">ìŠ¤íŠ¸ë ˆìŠ¤ ì •ë„ (1~5)</label>
          <input type="number" id="stressLevel" name="stress_level" min="1" max="5" required>
          <div class="help-text">1: ë§¤ìš° ë‚®ìŒ, 5: ë§¤ìš° ë†’ìŒ</div>
        </div>

        <div class="form-group">
          <label for="motivationLevel">ëŒ€í•™ì§„í•™ ì˜ìš• (1~5)</label>
          <input type="number" id="motivationLevel" name="motivation_level" min="1" max="5" required>
          <div class="help-text">1: ë§¤ìš° ë‚®ìŒ, 5: ë§¤ìš° ë†’ìŒ</div>
        </div>

        <div class="form-group">
          <label for="conditionLevel">ì»¨ë””ì…˜ (1~5)</label>
          <input type="number" id="conditionLevel" name="condition_level" min="1" max="5" required>
          <div class="help-text">1: ë§¤ìš° ë‚˜ì¨, 5: ë§¤ìš° ì¢‹ìŒ</div>
        </div>

        <div class="form-group">
          <label for="painLevel">ë¶€ìƒ í†µì¦ì •ë„ (1~5)</label>
          <input type="number" id="painLevel" name="pain_level" min="1" max="5" required>
          <div class="help-text">1: ì—†ìŒ, 5: ë§¤ìš° ì‹¬í•¨</div>
        </div>

        <div class="form-group">
          <label for="focusLevel">ìš´ë™ ì§‘ì¤‘ë„ (1~5)</label>
          <input type="number" id="focusLevel" name="focus_level" min="1" max="5" required>
          <div class="help-text">1: ë§¤ìš° ë‚®ìŒ, 5: ë§¤ìš° ë†’ìŒ</div>
        </div>

        <div class="form-group">
          <label for="studyLevel">í•™ìŠµ ì§‘ì¤‘ë„ (1~5)</label>
          <input type="number" id="studyLevel" name="study_level" min="1" max="5" required>
          <div class="help-text">1: ë§¤ìš° ë‚®ìŒ, 5: ë§¤ìš° ë†’ìŒ</div>
        </div>

        <div class="form-group">
          <label for="note">ê¸°íƒ€ ë©”ëª¨</label>
          <textarea id="note" name="note" placeholder="ê¸°íƒ€ ë‚´ìš© ë˜ëŠ” ë¶€ìƒë¶€ìœ„ë“±ì´ ìˆë‹¤ë©´ ì ì–´ì£¼ì„¸ìš”."></textarea>
        </div>

        <button type="submit" id="submitBtn">ì œì¶œí•˜ê¸°</button>
      </form>
      <div id="submitAlert" class="alert alert-warning" style="display: none;"></div>

    </div>

    <!-- ì œì¶œ ì™„ë£Œ í™”ë©´ -->
    <div class="form-card success-card" id="successContainer">
      <div class="success-icon">
        <i class="fas fa-check-circle"></i>
      </div>
      <div class="success-title">ì œì¶œì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!</div>
      <div class="success-message">
        ì˜¤ëŠ˜ë„ ê³ ìƒí–ˆì–´! ì„ ìƒë‹˜ë“¤ì€ í•­ìƒ ë„ˆí¬ë“¤ì„ ì‘ì›í•´!<br>
        ë©˜íƒˆ ê´€ë¦¬ëŠ” êµ‰ì¥íˆ ì¤‘ìš”í•œ ìš”ì†Œì´ë‹ˆ, í•­ìƒ í”ë“¤ë¦¬ì§€ ì•Šë„ë¡ 
        ìŒ¤ë“¤ì´ ë„ì™€ì¤„ê»˜!
      </div>
      
      <div class="success-details" id="successDetails">

        <!-- ì•„ë˜ success-details ë°”ë¡œ ë°‘ì— ì¶”ê°€í•´ì¤˜ -->


        <!-- ì œì¶œí•œ ë‚´ìš©ì´ ë™ì ìœ¼ë¡œ ì±„ì›Œì§‘ë‹ˆë‹¤ -->
      </div>
    </div>
  </div>

  <script>
    const BASE_URL = 'https://supermax.kr/college';
    let allStudents = [];

    async function loadStudents() {
      try {
        const response = await fetch(`${BASE_URL}/students`);
        allStudents = await response.json();
      } catch (error) {
        showAlert('í•™ìƒ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‚˜ì¤‘ì— ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.', 'warning');
        console.error('í•™ìƒ ëª©ë¡ ë¡œë”© ì˜¤ë¥˜:', error);
      }
    }

    function showAlert(message, type = 'warning') {
      const alertBox = document.getElementById('alertBox');
      alertBox.innerHTML = `
        <i class="fas fa-${type === 'warning' ? 'exclamation-circle' : 'check-circle'}"></i> ${message}
      `;
      alertBox.className = `alert alert-${type}`;
      alertBox.style.display = 'block';
      setTimeout(() => {
        alertBox.style.display = 'none';
      }, 5000);
    }

    document.getElementById('checkNameBtn').addEventListener('click', async () => {
      const nameInput = document.getElementById('studentName');
      const studentName = nameInput.value.trim();
      
      if (!studentName) {
        showAlert('í•™ìƒ ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
      }

      const foundStudent = allStudents.find(student => 
        student.name.trim() === studentName
      );

if (foundStudent) {
  document.getElementById('studentId').value = foundStudent.id;
  localStorage.setItem('student_name', foundStudent.name); // ğŸ‘‰ ì´ê±° ì¶”ê°€!
  showAlert(`${foundStudent.name} í•™ìƒ í™•ì¸ë˜ì—ˆìŠµë‹ˆë‹¤.`, 'success');
} else {
  document.getElementById('studentId').value = '';
  localStorage.removeItem('student_name'); // ğŸ‘‰ ì´ê±°ë„ ì¶”ê°€!
  showAlert(`
    ë“±ë¡ëœ í•™ìƒì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.<br>
    1. ì´ë¦„ì„ ì •í™•íˆ ì…ë ¥í–ˆëŠ”ì§€ í™•ì¸í•´ì£¼ì„¸ìš”<br>
    2. ê·¸ë˜ë„ ì•ˆë˜ë©´ ì›ì¥ë‹˜ê»˜ ë¬¸ì˜í•´ì£¼ì„¸ìš”
  `, 'warning');
}

    });

document.getElementById('mentalForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  const submitBtn = document.getElementById('submitBtn');
  submitBtn.disabled = true;
  submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ì œì¶œ ì¤‘...';

  const formData = new FormData(e.target);
  const studentName = localStorage.getItem('student_name');

  const payload = {
    ...Object.fromEntries(formData.entries()),
    student_name: studentName   // âœ… ì´ ì¤„ì´ í•µì‹¬!
  };

  if (!payload.student_id) {
    showAlert('í•™ìƒ í™•ì¸ì„ ë¨¼ì € í•´ì£¼ì„¸ìš”.');
    submitBtn.disabled = false;
    submitBtn.innerHTML = 'ì œì¶œí•˜ê¸°';
    return;
  }

  payload.submitted_at = new Date().toISOString().split('T')[0];

  try {
    const res = await fetch(`${BASE_URL}/mental-check`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });

    const result = await res.json();

    if (res.ok) {
      showSuccessScreen(payload);
    } else {
      showSubmitAlert(result.message || 'ì œì¶œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
      submitBtn.disabled = false;
      submitBtn.innerHTML = 'ì œì¶œí•˜ê¸°';
    }

  } catch (error) {
    showAlert('ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì¸í„°ë„· ì—°ê²°ì„ í™•ì¸í•´ì£¼ì„¸ìš”.', 'warning');
    console.error('ì œì¶œ ì˜¤ë¥˜:', error);
    submitBtn.disabled = false;
    submitBtn.innerHTML = 'ì œì¶œí•˜ê¸°';
  }
});


    function showSubmitAlert(message) {
  const box = document.getElementById('submitAlert');
  box.textContent = message;
  box.style.display = 'block';
  setTimeout(() => {
    box.style.display = 'none';
  }, 5000);
}


function showSuccessScreen(formData) {
  document.getElementById('formContainer').style.display = 'none';

  const detailsContainer = document.getElementById('successDetails');

  // 1. ê¸°ë³¸ ì œì¶œ ì •ë³´ ì„¸íŒ…
  detailsContainer.innerHTML = `
    <div class="detail-item">
      <span class="detail-label">í•™ìƒ ì´ë¦„</span>
      <span>${formData.student_name}</span>
    </div>
    <div class="detail-item">
      <span class="detail-label">ìˆ˜ë©´ ì‹œê°„</span>
      <span>${formData.sleep_hours || '0'}ì‹œê°„</span>
    </div>
    <div class="detail-item">
      <span class="detail-label">ìŠ¤íŠ¸ë ˆìŠ¤ ì •ë„</span>
      <span>${formData.stress_level}/5</span>
    </div>
    <div class="detail-item">
      <span class="detail-label">ëŒ€í•™ì§„í•™ì˜ìš•</span>
      <span>${formData.motivation_level}/5</span>
    </div>
    <div class="detail-item">
      <span class="detail-label">ì»¨ë””ì…˜</span>
      <span>${formData.condition_level}/5</span>
    </div>
    <div class="detail-item">
      <span class="detail-label">ë¶€ìƒ í†µì¦</span>
      <span>${formData.pain_level}/5</span>
    </div>
    <div class="detail-item">
      <span class="detail-label">ìš´ë™ ì§‘ì¤‘ë ¥</span>
      <span>${formData.focus_level}/5</span>
    </div>
    <div class="detail-item">
      <span class="detail-label">í•™ìŠµ ì§‘ì¤‘ë„</span>
      <span>${formData.study_level}/5</span>
    </div>
    ${formData.note ? `
    <div class="detail-item" style="flex-direction: column; align-items: flex-start;">
      <span class="detail-label">ê¸°íƒ€ ë©”ëª¨</span>
      <span>${formData.note}</span>
    </div>
    ` : ''}
  `;

  // 2. aiAdviceBox DOM ë™ì  ìƒì„± (null ë°©ì§€)
  const aiBox = document.createElement('div');
  aiBox.id = 'aiAdviceBox';
  aiBox.className = 'ai-analysis';
  aiBox.style.cssText = 'background:#eef5ff; border-left: 4px solid #4895ef; padding: 12px; border-radius: 8px; margin-top: 10px;';
  aiBox.innerHTML = 'AI ë¶„ì„ ì¤‘ì…ë‹ˆë‹¤...';
  detailsContainer.appendChild(aiBox);

  // 3. GPT ë¶„ì„ í˜¸ì¶œ
  loadAiAdvice(formData);

  document.getElementById('successContainer').style.display = 'block';
}

async function loadAiAdvice(data) {
  try {
    const res = await fetch(`${BASE_URL}/analyze-mental`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(data)
    });

    const result = await res.json();

    // ì´ì  ê³„ì‚° ë¡œì§
    const score =
      (parseFloat(data.sleep_hours) || 0) +
      (parseFloat(data.motivation_level) || 0) +
      (parseFloat(data.condition_level) || 0) +
      (parseFloat(data.focus_level) || 0) +
      (parseFloat(data.study_level) || 0) -
      (parseFloat(data.stress_level) || 0) -
      (parseFloat(data.pain_level) || 0);

    const roundedScore = Math.round(score * 10) / 10;

    const adviceBox = document.getElementById('aiAdviceBox');
    adviceBox.innerHTML = `
      <strong>ì´ì :</strong> ${roundedScore}ì <br><br>
      <strong>ì›ì¥ë‹˜AI ë¶„ì„ ê²°ê³¼:</strong><br>
      ${result.comment}
    `;
  } catch (error) {
    const adviceBox = document.getElementById('aiAdviceBox');
    adviceBox.innerHTML = `<span style="color:red;">AI ë¶„ì„ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.</span>`;
    console.error('GPT ë¶„ì„ ì˜¤ë¥˜:', error);
  }
}



    document.addEventListener('DOMContentLoaded', loadStudents);
  </script>
</body>
</html>
