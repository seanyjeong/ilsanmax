<!-- student-detail.html -->
<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>í•™ìƒ ìƒì„¸ ì •ë³´</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/water.css@2/out/water.css" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>
  <style>
    .info-box { border: 1px solid #ccc; padding: 1em; margin-bottom: 1em; }
    canvas { max-width: 100%; }
    h3 { margin-top: 2em; }
  </style>
</head>
<body>
  <h2>ğŸ“‹ í•™ìƒ ìƒì„¸ ì •ë³´</h2>
  <div class="info-box" id="basicInfo">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>

  <h3>ğŸ“Š ëª¨ì˜ê³ ì‚¬ ì„±ì  (3, 6, 9ì›”)</h3>
  <div class="info-box" id="examScores">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>

  <h3>ğŸƒ ì‹¤ê¸° ê¸°ë¡</h3>
  <div class="info-box" id="recordScores">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>

  <h3>ğŸ§  AI ì‹¤ê¸° ë¶„ì„</h3>
  <div class="info-box" id="gptComment">ë¶„ì„ ì¡°ê±´ í™•ì¸ ì¤‘...</div>

  <h3>ğŸ§  ë©˜íƒˆ ìê°€ ì²´í¬ ì´ë ¥</h3>
  <div class="info-box" id="mentalChecks">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>

  <script>
    const BASE_URL = 'https://supermax.kr/college';
    const studentId = new URLSearchParams(location.search).get('id');

    const reverseEvents = [
      '10mì™•ë³µ(ë²„íŠ¼)', '10mì™•ë³µ(ì½˜)', '20mì™•ë³µ(ë²„íŠ¼)', '20mì™•ë³µ(ì½˜)'
    ];

    async function loadBasicInfo() {
      const res = await fetch(`${BASE_URL}/students/${studentId}`);
      const data = await res.json();
      document.getElementById('basicInfo').innerHTML = `
        <strong>ì´ë¦„:</strong> ${data.name}<br>
        <strong>í•™êµ:</strong> ${data.school}<br>
        <strong>í•™ë…„:</strong> ${data.grade}<br>
        <strong>ì„±ë³„:</strong> ${data.gender}<br>
        <strong>ìˆ˜ì‹œ/ì •ì‹œ:</strong> ${data.lesson_type}<br>
        <strong>ë‹´ë‹¹ ê°•ì‚¬:</strong> ${data.instructor_name || '-'}`;
    }

    async function loadExamScores() {
      const res = await fetch(`${BASE_URL}/mock-score/${studentId}`);
      const allScores = await res.json();
      const months = ['3ì›”', '6ì›”', '9ì›”'];
      const container = document.getElementById('examScores');
      container.innerHTML = '';

      months.forEach(month => {
        const score = allScores.find(s => s.exam_month === month);
        if (!score) return;
        container.innerHTML += `
          <strong>ğŸ“… ${month} ëª¨ì˜ê³ ì‚¬</strong><br>
          - êµ­ì–´ (${score.korean_subject}): í‘œì¤€ ${score.korean_standard_score}, ë°±ë¶„ìœ„ ${score.korean_percentile}, ë“±ê¸‰ ${score.korean_grade}<br>
          - ìˆ˜í•™ (${score.math_subject}): í‘œì¤€ ${score.math_standard_score}, ë°±ë¶„ìœ„ ${score.math_percentile}, ë“±ê¸‰ ${score.math_grade}<br>
          - ì˜ì–´: ë“±ê¸‰ ${score.english_grade}<br>
          - íƒêµ¬1 (${score.inquiry1_subject}): í‘œì¤€ ${score.inquiry1_standard_score}, ë°±ë¶„ìœ„ ${score.inquiry1_percentile}, ë“±ê¸‰ ${score.inquiry1_grade}<br>
          - íƒêµ¬2 (${score.inquiry2_subject}): í‘œì¤€ ${score.inquiry2_standard_score}, ë°±ë¶„ìœ„ ${score.inquiry2_percentile}, ë“±ê¸‰ ${score.inquiry2_grade}<br>
          - í•œêµ­ì‚¬: ë“±ê¸‰ ${score.history_grade}<br><br>`;
      });
    }

    async function loadRecordScores() {
      const res = await fetch(`${BASE_URL}/physical-record/${studentId}`);
      const data = await res.json();
      const container = document.getElementById('recordScores');
      if (!Array.isArray(data) || data.length === 0) {
        container.textContent = 'ì‹¤ê¸° ê¸°ë¡ ì—†ìŒ';
        document.getElementById('gptComment').textContent = 'ì‹¤ê¸° ê¸°ë¡ ì—†ìŒ';
        return;
      }

      const grouped = {};
      data.forEach(r => {
        const event = r.event_name;
        if (!grouped[event]) grouped[event] = [];
        grouped[event].push({ date: r.recorded_at, record: parseFloat(r.record_value) });
      });

      container.innerHTML = '';
      const chartRefs = {};
      let chartIndex = 0;
      const decimalPlaces = {
        'ì œìë¦¬ë©€ë¦¬ë›°ê¸°': 0,
        'ë©”ë””ì‹ ë³¼ë˜ì§€ê¸°': 1,
        'ë°°ê·¼ë ¥': 1,
        'ì¢Œì „êµ´': 1,
        '10mì™•ë³µ(ë²„íŠ¼)': 2,
        '10mì™•ë³µ(ì½˜)': 2,
        '20mì™•ë³µ(ë²„íŠ¼)': 2,
        '20mì™•ë³µ(ì½˜)': 2
      };

      for (const event in grouped) {
        const records = grouped[event];
        const validRecords = records
          .filter(r => !isNaN(r.record))
          .sort((a, b) => new Date(a.date) - new Date(b.date));
        if (validRecords.length === 0) continue;

        const safeId = event.replace(/[^\w\-]/g, '_') + '_' + chartIndex++;
        const labels = validRecords.map(r => r.date.slice(0, 10));
        const values = validRecords.map(r => r.record);

        const block = document.createElement('div');
        block.innerHTML = `
          <h4>${event}</h4>
          <canvas id="chart-${safeId}"></canvas>
        `;
        container.appendChild(block);

        const ctx = document.getElementById(`chart-${safeId}`).getContext('2d');
        const isReverse = reverseEvents.includes(event);
        const decimal = decimalPlaces[event] ?? 1;

        const chart = new Chart(ctx, {
          type: 'line',
          data: {
            labels,
            datasets: [{
              label: event,
              data: values,
              tension: 0.3,
              fill: false,
              datalabels: {
                align: 'top',
                anchor: 'end'
              }
            }]
          },
          options: {
            plugins: {
              datalabels: {
                formatter: value => value.toFixed(decimal),
                font: { weight: 'bold' }
              }
            },
            responsive: true,
            scales: {
              y: {
                beginAtZero: false,
                reverse: isReverse,
                ticks: {
                  callback: value => Number.isInteger(value) ? value : value.toFixed(decimal),
                  stepSize: (values.length === 2) ? Math.abs(values[1] - values[0]) : undefined,
                  min: (values.length === 2) ? Math.min(...values) : undefined,
                  max: (values.length === 2) ? Math.max(...values) : undefined
                }
              }
            }
          },
          plugins: [ChartDataLabels]
        });

        chartRefs[safeId] = chart;
      }

      // âœ… GPT ë¶„ì„ ì¡°ê±´
      const totalValid = data.filter(r => !isNaN(parseFloat(r.record_value))).length;
      if (totalValid < 3) {
        document.getElementById('gptComment').textContent = 'ë¶„ì„ì„ ìœ„í•´ ìµœì†Œ 3ê°œ ì´ìƒì˜ ê¸°ë¡ì´ í•„ìš”í•©ë‹ˆë‹¤.';
      } else {
        loadGptComment();
      }
    }

async function loadGptComment() {
  console.log("ğŸ” [loadGptComment] í˜¸ì¶œë¨, studentId:", studentId);

  try {
    const res = await fetch('https://supermax.kr/college/analyze-comment', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ student_id: studentId })
    });

    if (!res.ok) {
      const err = await res.text();
      console.error("âŒ ì‘ë‹µ ì˜¤ë¥˜:", res.status, err);
      document.getElementById('gptComment').innerHTML = 'ë¶„ì„ ì‹¤íŒ¨ (ì„œë²„ ì‘ë‹µ ì˜¤ë¥˜)';
      return;
    }

    const data = await res.json();
    console.log("ğŸ“¥ GPT ì‘ë‹µ:", data);
    document.getElementById('gptComment').innerHTML = `<strong>ğŸ§  AI ë¶„ì„:</strong><br>${data.comment}`;

  } catch (err) {
    console.error("âŒ GPT API í˜¸ì¶œ ì‹¤íŒ¨:", err);
    document.getElementById('gptComment').innerHTML = 'âŒ ë¶„ì„ ê²°ê³¼ë¥¼ ë°›ì•„ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. (ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜)';
  }
}



    async function loadMentalChecks() {
      const res = await fetch(`${BASE_URL}/mental-check/${studentId}`);
      const data = await res.json();
      const container = document.getElementById('mentalChecks');
      if (!Array.isArray(data) || data.length === 0) {
        container.textContent = 'ë°ì´í„° ì—†ìŒ';
        return;
      }

      const entries = data.map(entry => {
        const {
          submitted_at, sleep_hours, stress_level, motivation_level,
          condition_level, pain_level, focus_level, study_level, note
        } = entry;

        const score =
          (sleep_hours || 0) +
          (motivation_level || 0) +
          (condition_level || 0) +
          (focus_level || 0) +
          (study_level || 0) -
          (stress_level || 0) -
          (pain_level || 0);

        let status = '';
        if (score >= 13) status = 'âœ… ì •ìƒ';
        else if (score >= 10) status = 'âš ï¸ ê´€ì‹¬ í•„ìš”';
        else if (score >= 6) status = 'â— ê´€ë¦¬ í•„ìš”';
        else status = 'ğŸ”¥ ì‹¬ê°';

        return `
          <div style="margin-bottom:1em;">
            <strong>${submitted_at}</strong><br>
            ì´ì : ${score} â†’ <strong>${status}</strong><br>
            - ìˆ˜ë©´: ${sleep_hours}ì‹œê°„<br>
            - ìŠ¤íŠ¸ë ˆìŠ¤: ${stress_level} / 5<br>
            - ì˜ìš•: ${motivation_level} / 5<br>
            - ì»¨ë””ì…˜: ${condition_level} / 5<br>
            - í†µì¦: ${pain_level} / 5<br>
            - ì§‘ì¤‘: ${focus_level} / 5<br>
            - í•™ìŠµ: ${study_level} / 5<br>
            ë©”ëª¨: ${note || 'ì—†ìŒ'}
          </div>`;
      });

      container.innerHTML = entries[0];
    }

    loadBasicInfo();
    loadExamScores();
    loadRecordScores();
    loadMentalChecks();
  </script>
</body>
</html>
