<!-- student-detail.html -->
<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>학생 상세 정보</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/water.css@2/out/water.css" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>
  <style>
    .info-box { border: 1px solid #ccc; padding: 1em; margin-bottom: 1em; }
    canvas { max-width: 100%; }
    h3 { margin-top: 2em; }
  </style>
</head>
<body>
  <h2>📋 학생 상세 정보</h2>
  <div class="info-box" id="basicInfo">불러오는 중...</div>

  <h3>📊 모의고사 성적 (3, 6, 9월)</h3>
  <div class="info-box" id="examScores">불러오는 중...</div>

  <h3>🏃 실기 기록</h3>
  <div class="info-box" id="recordScores">불러오는 중...</div>

  <h3>🧠 AI 실기 분석</h3>
  <div class="info-box" id="gptComment">분석 조건 확인 중...</div>

  <h3>🧠 멘탈 자가 체크 이력</h3>
  <div class="info-box" id="mentalChecks">불러오는 중...</div>

  <script>
    const BASE_URL = 'https://supermax.kr/college';
    const studentId = new URLSearchParams(location.search).get('id');

    const reverseEvents = [
      '10m왕복(버튼)', '10m왕복(콘)', '20m왕복(버튼)', '20m왕복(콘)'
    ];

    async function loadBasicInfo() {
      const res = await fetch(`${BASE_URL}/students/${studentId}`);
      const data = await res.json();
      document.getElementById('basicInfo').innerHTML = `
        <strong>이름:</strong> ${data.name}<br>
        <strong>학교:</strong> ${data.school}<br>
        <strong>학년:</strong> ${data.grade}<br>
        <strong>성별:</strong> ${data.gender}<br>
        <strong>수시/정시:</strong> ${data.lesson_type}<br>
        <strong>담당 강사:</strong> ${data.instructor_name || '-'}`;
    }

    async function loadExamScores() {
      const res = await fetch(`${BASE_URL}/mock-score/${studentId}`);
      const allScores = await res.json();
      const months = ['3월', '6월', '9월'];
      const container = document.getElementById('examScores');
      container.innerHTML = '';

      months.forEach(month => {
        const score = allScores.find(s => s.exam_month === month);
        if (!score) return;
        container.innerHTML += `
          <strong>📅 ${month} 모의고사</strong><br>
          - 국어 (${score.korean_subject}): 표준 ${score.korean_standard_score}, 백분위 ${score.korean_percentile}, 등급 ${score.korean_grade}<br>
          - 수학 (${score.math_subject}): 표준 ${score.math_standard_score}, 백분위 ${score.math_percentile}, 등급 ${score.math_grade}<br>
          - 영어: 등급 ${score.english_grade}<br>
          - 탐구1 (${score.inquiry1_subject}): 표준 ${score.inquiry1_standard_score}, 백분위 ${score.inquiry1_percentile}, 등급 ${score.inquiry1_grade}<br>
          - 탐구2 (${score.inquiry2_subject}): 표준 ${score.inquiry2_standard_score}, 백분위 ${score.inquiry2_percentile}, 등급 ${score.inquiry2_grade}<br>
          - 한국사: 등급 ${score.history_grade}<br><br>`;
      });
    }

    async function loadRecordScores() {
      const res = await fetch(`${BASE_URL}/physical-record/${studentId}`);
      const data = await res.json();
      const container = document.getElementById('recordScores');
      if (!Array.isArray(data) || data.length === 0) {
        container.textContent = '실기 기록 없음';
        document.getElementById('gptComment').textContent = '실기 기록 없음';
        return;
      }

      const grouped = {};
      data.forEach(r => {
        const event = r.event_name;
        if (!grouped[event]) grouped[event] = [];
        grouped[event].push({ date: r.recorded_at, record: parseFloat(r.record_value) });
      });

      container.innerHTML = '';
      const chartRefs = {};
      let chartIndex = 0;
      const decimalPlaces = {
        '제자리멀리뛰기': 0,
        '메디신볼던지기': 1,
        '배근력': 1,
        '좌전굴': 1,
        '10m왕복(버튼)': 2,
        '10m왕복(콘)': 2,
        '20m왕복(버튼)': 2,
        '20m왕복(콘)': 2
      };

      for (const event in grouped) {
        const records = grouped[event];
        const validRecords = records
          .filter(r => !isNaN(r.record))
          .sort((a, b) => new Date(a.date) - new Date(b.date));
        if (validRecords.length === 0) continue;

        const safeId = event.replace(/[^\w\-]/g, '_') + '_' + chartIndex++;
        const labels = validRecords.map(r => r.date.slice(0, 10));
        const values = validRecords.map(r => r.record);

        const block = document.createElement('div');
        block.innerHTML = `
          <h4>${event}</h4>
          <canvas id="chart-${safeId}"></canvas>
        `;
        container.appendChild(block);

        const ctx = document.getElementById(`chart-${safeId}`).getContext('2d');
        const isReverse = reverseEvents.includes(event);
        const decimal = decimalPlaces[event] ?? 1;

        const chart = new Chart(ctx, {
          type: 'line',
          data: {
            labels,
            datasets: [{
              label: event,
              data: values,
              tension: 0.3,
              fill: false,
              datalabels: {
                align: 'top',
                anchor: 'end'
              }
            }]
          },
          options: {
            plugins: {
              datalabels: {
                formatter: value => value.toFixed(decimal),
                font: { weight: 'bold' }
              }
            },
            responsive: true,
            scales: {
              y: {
                beginAtZero: false,
                reverse: isReverse,
                ticks: {
                  callback: value => Number.isInteger(value) ? value : value.toFixed(decimal),
                  stepSize: (values.length === 2) ? Math.abs(values[1] - values[0]) : undefined,
                  min: (values.length === 2) ? Math.min(...values) : undefined,
                  max: (values.length === 2) ? Math.max(...values) : undefined
                }
              }
            }
          },
          plugins: [ChartDataLabels]
        });

        chartRefs[safeId] = chart;
      }

      // ✅ GPT 분석 조건
      const totalValid = data.filter(r => !isNaN(parseFloat(r.record_value))).length;
      if (totalValid < 3) {
        document.getElementById('gptComment').textContent = '분석을 위해 최소 3개 이상의 기록이 필요합니다.';
      } else {
        loadGptComment();
      }
    }

async function loadGptComment() {
  console.log("🔍 [loadGptComment] 호출됨, studentId:", studentId);

  try {
    const res = await fetch('https://supermax.kr/college/analyze-comment', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ student_id: studentId })
    });

    if (!res.ok) {
      const err = await res.text();
      console.error("❌ 응답 오류:", res.status, err);
      document.getElementById('gptComment').innerHTML = '분석 실패 (서버 응답 오류)';
      return;
    }

    const data = await res.json();
    console.log("📥 GPT 응답:", data);
    document.getElementById('gptComment').innerHTML = `<strong>🧠 AI 분석:</strong><br>${data.comment}`;

  } catch (err) {
    console.error("❌ GPT API 호출 실패:", err);
    document.getElementById('gptComment').innerHTML = '❌ 분석 결과를 받아오지 못했습니다. (네트워크 오류)';
  }
}



    async function loadMentalChecks() {
      const res = await fetch(`${BASE_URL}/mental-check/${studentId}`);
      const data = await res.json();
      const container = document.getElementById('mentalChecks');
      if (!Array.isArray(data) || data.length === 0) {
        container.textContent = '데이터 없음';
        return;
      }

      const entries = data.map(entry => {
        const {
          submitted_at, sleep_hours, stress_level, motivation_level,
          condition_level, pain_level, focus_level, study_level, note
        } = entry;

        const score =
          (sleep_hours || 0) +
          (motivation_level || 0) +
          (condition_level || 0) +
          (focus_level || 0) +
          (study_level || 0) -
          (stress_level || 0) -
          (pain_level || 0);

        let status = '';
        if (score >= 13) status = '✅ 정상';
        else if (score >= 10) status = '⚠️ 관심 필요';
        else if (score >= 6) status = '❗ 관리 필요';
        else status = '🔥 심각';

        return `
          <div style="margin-bottom:1em;">
            <strong>${submitted_at}</strong><br>
            총점: ${score} → <strong>${status}</strong><br>
            - 수면: ${sleep_hours}시간<br>
            - 스트레스: ${stress_level} / 5<br>
            - 의욕: ${motivation_level} / 5<br>
            - 컨디션: ${condition_level} / 5<br>
            - 통증: ${pain_level} / 5<br>
            - 집중: ${focus_level} / 5<br>
            - 학습: ${study_level} / 5<br>
            메모: ${note || '없음'}
          </div>`;
      });

      container.innerHTML = entries[0];
    }

    loadBasicInfo();
    loadExamScores();
    loadRecordScores();
    loadMentalChecks();
  </script>
</body>
</html>
